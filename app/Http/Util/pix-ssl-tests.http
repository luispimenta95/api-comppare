### Configurações de variáveis (configure conforme seu ambiente)
@baseUrl = http://localhost:8000
@token = seu_token_jwt_aqui

### TESTE: Configuração de Webhook PIX com SSL desabilitado (desenvolvimento)
PUT {{baseUrl}}/api/pix/webhook
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "webhookUrl": "https://localhost:8000/api/pix/atualizar"
}

### Response esperado (SSL verification desabilitada):
# {
#   "codRetorno": 200,
#   "message": "Webhook configurado com sucesso",
#   "dados": {
#     "webhookUrl": "https://localhost:8000/api/pix/atualizar",
#     "ambiente": "local",
#     "ssl_verification": "disabled"
#   }
# }

### TESTE: Verificar status de SSL no endpoint
GET {{baseUrl}}/api/pix/ssl-status
Authorization: Bearer {{token}}

### Response esperado:
# {
#   "codRetorno": 200,
#   "dados": {
#     "environment": "local",
#     "ssl_verify_disabled": true,
#     "certificates": {
#       "cliente_homologacao": "presente",
#       "cliente_producao": "ausente"
#     }
#   }
# }

### TESTE: Simular erro de certificado auto-assinado
PUT {{baseUrl}}/api/pix/webhook
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "webhookUrl": "https://self-signed.badssl.com/api/webhook"
}

### Response esperado (com SSL verification ativa):
# {
#   "codRetorno": 500,
#   "message": "Erro ao configurar webhook",
#   "error": "SSL certificate problem: self-signed certificate in certificate chain. SOLUÇÃO PARA DESENVOLVIMENTO: Configure SSL_VERIFY_DISABLED=true no arquivo .env para desabilitar verificação SSL em ambiente local.",
#   "tipo_erro": "SSL_CERTIFICATE_PROBLEM",
#   "ambiente": "local"
# }

### TESTE: Configurar webhook com URL HTTP (apenas desenvolvimento)
PUT {{baseUrl}}/api/pix/webhook
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "webhookUrl": "http://localhost:8000/api/pix/atualizar"
}

### Response esperado:
# {
#   "codRetorno": 422,
#   "message": "Erro ao configurar webhook",
#   "error": "URL do webhook não atende aos requisitos da EFI. Requisitos: HTTPS obrigatório, TLS mútuo configurado, URL acessível externamente."
# }

### TESTE ESPECÍFICO: Resolver "self-signed certificate in certificate chain"
### 
### Este teste ajuda a resolver o erro que você está enfrentando

### 1. Primeiro, verifique o status atual do SSL
GET {{baseUrl}}/pix/ssl-status
Authorization: Bearer {{token}}

### 2. Configure o ambiente para desenvolvimento (se ainda não configurado)
### Adicione estas linhas no seu .env:
# APP_ENV=local
# SSL_VERIFY_DISABLED=true
# WEBHOOK_PIX_URL=http://localhost:8000/api/pix/atualizar

### 3. Teste a configuração do webhook com SSL desabilitado
PUT {{baseUrl}}/pix/webhook
Content-Type: application/json
Authorization: Bearer {{token}}

{}

### 4. Se ainda der erro, tente com URL HTTP (apenas para teste local)
PUT {{baseUrl}}/pix/webhook
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "webhookUrl": "http://localhost:8000/api/pix/atualizar"
}

### 5. Para usar HTTPS válido em desenvolvimento, use ngrok:
### - Instale ngrok: https://ngrok.com/download
### - Execute: ngrok http 8000
### - Use a URL HTTPS gerada:
PUT {{baseUrl}}/pix/webhook
Content-Type: application/json
Authorization: Bearer {{token}}

{
    "webhookUrl": "https://sua-url-ngrok.ngrok.io/api/pix/atualizar"
}

### COMANDOS ÚTEIS:
### - Diagnóstico completo: php artisan pix:diagnose-ssl
### - Diagnóstico com correções: php artisan pix:diagnose-ssl --fix
### - Script de configuração: ./configure-ssl-dev.sh
### - Verificar rotas: php artisan route:list | grep pix

### CONFIGURAÇÕES NECESSÁRIAS NO .env PARA TESTE:

# APP_ENV=local
# SSL_VERIFY_DISABLED=true
# WEBHOOK_PIX_URL=https://localhost:8000/api/pix/atualizar
# EFI_CLIENT_ID=seu_client_id_homologacao
# EFI_CLIENT_SECRET=seu_client_secret_homologacao

### CERTIFICADOS NECESSÁRIOS:
# storage/app/certificates/cliente.pem (homologação)
# storage/app/certificates/cliente.key (homologação)
# storage/app/certificates/hml.pem (EFI homologação)

### COMO RESOLVER ERRO "self-signed certificate":

# 1. Para DESENVOLVIMENTO (recomendado):
#    - Configure SSL_VERIFY_DISABLED=true no .env
#    - Configure APP_ENV=local no .env
#    - Sistema automaticamente desabilitará verificação SSL

# 2. Para PRODUÇÃO:
#    - Configure APP_ENV=production no .env
#    - Use certificados SSL válidos
#    - Configure TLS mútuo no servidor web
#    - Use URL webhook com HTTPS válido

# 3. Para TESTES com ngrok:
#    - Instale ngrok: https://ngrok.com/
#    - Execute: ngrok http 8000
#    - Use URL HTTPS gerada como WEBHOOK_PIX_URL
#    - ngrok fornece certificado SSL válido automaticamente

### TESTE TLS MÚTUO: Validação de certificados cliente

### 1. Testar endpoint de validação TLS
GET {{baseUrl}}/pix/test-tls
Authorization: Bearer {{token}}

### Response esperado (desenvolvimento - sem TLS mútuo):
# {
#   "codRetorno": 200,
#   "message": "Teste de TLS mútuo executado",
#   "dados": {
#     "tls_mutuo_valido": true,
#     "ambiente": "local",
#     "ssl_verify_disabled": true,
#     "ssl_info": {
#       "ssl_client_cert": "ausente",
#       "ssl_client_verify": "não verificado"
#     },
#     "observacao": "Requisição passaria na validação TLS mútuo"
#   }
# }

### 2. Testar webhook PIX (agora com validação TLS mútuo)
POST {{baseUrl}}/pix/atualizar
Content-Type: application/json

{
  "recs": [
    {
      "idRec": "RR1026652320240821lab77511abf",
      "status": "APROVADA"
    }
  ]
}

### Response esperado (desenvolvimento):
# {
#   "codRetorno": 200,
#   "message": "Atualização de cobranças processada",
#   "total_processados": 1,
#   "resultados": [...]
# }

### Response esperado (produção sem certificado válido):
# {
#   "codRetorno": 403,
#   "message": "Acesso negado. Este endpoint requer autenticação TLS mútuo válida.",
#   "error": "CLIENT_CERTIFICATE_REQUIRED",
#   "observacao": "Apresente um certificado cliente válido da EFI Pay."
# }

### 3. Simulação de acesso sem TLS mútuo (em produção)
### Configure no .env:
# APP_ENV=production
# SSL_VERIFY_DISABLED=false

### Então teste:
POST {{baseUrl}}/pix/atualizar
Content-Type: application/json

{
  "teste": "acesso_sem_certificado"
}

### Deve retornar 403 Forbidden
