# Configuração Nginx para TLS Mútuo - Webhook PIX EFI
# /etc/nginx/sites-available/api-comppare-tls-mutual

server {
    listen 443 ssl http2;
    server_name api.comppare.com.br;

    # Certificados SSL do servidor
    ssl_certificate /etc/ssl/certs/api.comppare.com.br.crt;
    ssl_certificate_key /etc/ssl/private/api.comppare.com.br.key;

    # Configurações SSL básicas
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # ===== CONFIGURAÇÃO TLS MÚTUO PARA WEBHOOK PIX =====
    
    # CA da EFI para validar certificados cliente
    ssl_client_certificate /etc/ssl/certs/efi-ca.crt;
    
    # Localização específica para webhook PIX - TLS mútuo OBRIGATÓRIO
    location /api/pix/atualizar {
        # Exigir certificado cliente válido
        ssl_verify_client on;
        ssl_verify_depth 2;
        
        # Passar informações do certificado para a aplicação
        proxy_set_header SSL-Client-Cert $ssl_client_cert;
        proxy_set_header SSL-Client-Verify $ssl_client_verify;
        proxy_set_header SSL-Client-Subject-DN $ssl_client_s_dn;
        proxy_set_header SSL-Client-Issuer-DN $ssl_client_i_dn;
        proxy_set_header SSL-Protocol $ssl_protocol;
        proxy_set_header SSL-Cipher $ssl_cipher;
        
        # Proxy para Laravel
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Outras rotas da API - TLS mútuo OPCIONAL
    location /api/ {
        # Certificado cliente opcional para outras rotas
        ssl_verify_client optional;
        ssl_verify_depth 2;
        
        # Ainda passar informações do certificado se presente
        proxy_set_header SSL-Client-Cert $ssl_client_cert;
        proxy_set_header SSL-Client-Verify $ssl_client_verify;
        proxy_set_header SSL-Client-Subject-DN $ssl_client_s_dn;
        proxy_set_header SSL-Client-Issuer-DN $ssl_client_i_dn;
        
        # Proxy para Laravel
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Endpoint de teste TLS mútuo
    location /api/pix/test-tls {
        ssl_verify_client optional;
        ssl_verify_depth 2;
        
        proxy_set_header SSL-Client-Cert $ssl_client_cert;
        proxy_set_header SSL-Client-Verify $ssl_client_verify;
        proxy_set_header SSL-Client-Subject-DN $ssl_client_s_dn;
        proxy_set_header SSL-Client-Issuer-DN $ssl_client_i_dn;
        proxy_set_header SSL-Protocol $ssl_protocol;
        proxy_set_header SSL-Cipher $ssl_cipher;
        
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Logs específicos para debug de TLS
    access_log /var/log/nginx/api-comppare-ssl-access.log;
    error_log /var/log/nginx/api-comppare-ssl-error.log;
}

# ===== INSTRUÇÕES DE CONFIGURAÇÃO =====

# 1. Obter certificado CA da EFI:
#    - Baixe o certificado raiz/intermediário da EFI
#    - Salve como /etc/ssl/certs/efi-ca.crt

# 2. Configurar certificados do servidor:
#    - Certificado SSL válido para api.comppare.com.br
#    - Chave privada correspondente

# 3. Testar configuração:
#    sudo nginx -t

# 4. Recarregar Nginx:
#    sudo systemctl reload nginx

# 5. Verificar logs:
#    tail -f /var/log/nginx/api-comppare-ssl-error.log

# ===== TESTE COM CURL =====

# Teste SEM certificado cliente (deve falhar):
# curl https://api.comppare.com.br/api/pix/atualizar

# Teste COM certificado cliente da EFI:
# curl --cert cliente-efi.pem --key cliente-efi.key \
#      https://api.comppare.com.br/api/pix/atualizar

# Teste do endpoint de debug:
# curl https://api.comppare.com.br/api/pix/test-tls
